<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Dual Map Viewer (Google / Kakao / Naver) + Full GIS Features</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html,body{margin:0;height:100%;font-family:Arial;}
    #controls{display:flex;gap:20px;padding:8px;background:#222;color:#fff;flex-wrap:wrap;}
    .panel{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    #searchInput{width:260px;padding:4px 6px;}
    #container{display:flex;height:calc(100% - 48px);}
    .map{flex:1;position:relative;}
    #suggestList{
      position:absolute;top:36px;left:42%;transform:translateX(-50%);
      width:280px;max-height:600px;overflow-y:auto;background:#fff;
      border:1px solid #888;z-index:100;display:none;
    }
    #suggestList div{padding:6px 10px;border-bottom:1px solid #eee;cursor:pointer;color:black;}
    #suggestList div:hover{background:#cce5ff;}
    

    /* ******* ë‚´ê°€ ì¶”ê°€í•œ ì½”ë“œ***** */
    
    /* Input ë°•ìŠ¤ í°íŠ¸ */
    #searchInput {
      font-size: 16px !important;  /* 12px=ì‘ê²Œ, 16px=í¬ê²Œ */
      font-family: Arial, sans-serif;
    }

    /* ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ í°íŠ¸ */
    #suggestList div {
      font-size: 16px !important;  /* Inputê³¼ ë™ì¼í•˜ê²Œ */
      font-family: Arial, sans-serif;
    }

    /* ì§€ë„/ìœ„ì„± í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì ˆ */
    
    #leftType, #rightType {
      padding-top: 0px;    /* í…ìŠ¤íŠ¸ ìœ„ìª½ ì—¬ë°± â†‘ */
      padding-bottom: 0px;  /* í…ìŠ¤íŠ¸ ì•„ë˜ìª½ ì—¬ë°± â†‘ */
      padding-left: 12px;   /* ì¢Œìš°ëŠ” ê·¸ëŒ€ë¡œ */
      padding-right: 12px;
      font-size: 16px; 
    }

    /* ì§€ë„ì„ íƒ ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ í¬ê¸° ì¡°ì ˆ */
    select#leftSelect, select#rightSelect {
      width: 86px;      /* ê°€ë¡œ ê¸¸ì´ */
      height: 26px;     /* ì„¸ë¡œ ë†’ì´ */
      padding: 4px 6px; /* ë‚´ë¶€ ì—¬ë°± */
      font-size: 15px;  /* ê¸€ì í¬ê¸° */
    }
    /* Go, ì§€ì›€ë²„íŠ¼ í¬ê¸°ì¡°ì ˆ - ë‚´ê°€ ì¶”ê°€í•œ ì½”ë“œ */
    #searchBtn, #clearSearchBtn {
      padding: 6px 12px;  /* ìœ„ì•„ë˜ 6px, ì¢Œìš° 12px ì—¬ë°± */
      height: 28px;       /* ê³ ì • ë†’ì´ */
      font-size: 13px;    /* ê¸€ì í¬ê¸° */
      min-width: 50px;    /* ìµœì†Œ ë„ˆë¹„ */
    }
    /* ******* ë‚´ê°€ ì¶”ê°€í•œ ì½”ë“œ***** */

    /* ì¹´ì¹´ì˜¤ GIS ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
    .kakao-wrap-inner{position:relative;width:100%;height:100%;}
    #kakao-roadview{position:absolute;top:0;left:0;width:100%;height:100%;background:#333;z-index:5;display:none;}
    #kakao-map{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;background:#eee;}
    #kakao-map.minimap{
      width:400px !important;height:350px !important;top:auto !important;bottom:0;left:0;
      z-index:20;border-top:1px solid #888;border-right:1px solid #888;
      box-shadow:2px -2px 5px rgba(0,0,0,0.3);
    }

    /* GIS íˆ´ë°” */
    .kakao-toolbar{
      position:absolute;top:5px;right:40px;z-index:30;
      background:white;border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex;overflow:hidden;
    }
    .kakao-toolbar button{
      background:#fff;border:0;border-right:1px solid #ddd;
      padding:8px 12px;cursor:pointer;font-weight:bold;font-size:12px;
    }
    .kakao-toolbar button:last-child{border-right:none;}
    .kakao-toolbar button:hover{background:#f5f5f5;}
    .kakao-toolbar button.active{background:#3396ff;color:white;}
    .kakao-toolbar button.delete-btn{color:#e14f4f;}

    /* ë¡œë“œë·° ë‹«ê¸° */
    #rv-close-btn{
      position:absolute;top:10px;right:10px;z-index:30;
      padding:10px 15px;background:#333;color:white;
      border:1px solid #555;cursor:pointer;border-radius:3px;
      font-weight:bold;display:none;
    }
    #rv-close-btn:hover{background:#555;}

    /* ì¸¡ì • ì˜¤ë²„ë ˆì´ */
    .info-overlay{
      background:white;border:1px solid #333;border-radius:4px;
      padding:10px;font-size:12px;
      box-shadow:2px 2px 5px rgba(0,0,0,0.3);white-space:nowrap;
    }
    .measure-label{
      background:#fff;padding:3px 6px;border:1px solid #888;
      border-radius:3px;font-size:11px;color:#333;
      box-shadow:1px 1px 3px rgba(0,0,0,0.2);white-space:nowrap;
    }

    /* ê²€ìƒ‰ ë§ˆì»¤ */
    .search-marker {
      width: 24px;
      height: 32px;
      margin-left: -12px;
      margin-top: -32px;
      background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDBMMCAxNiBMNiAxNiBMNiAyNCBMMTIgMjQgTDE4IDE2IEwyNCAxNiBaIiBmaWxsPSIjRkY0MDAwIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9IiNGRkYiLz4KPC9zdmc+') no-repeat;
    }

    /* ì›Œì»¤ ë¡œë“œë·°ì˜ ê±¸ìŒ*/
    .MapWalker{
      position:absolute;width:24px;height:24px;
      margin:-12px 0 0 -12px;pointer-events:none;
    }
    .MapWalker .angleBack{
      position:absolute;top:50%;left:50%;width:0;height:0;
      border-left:20px solid transparent;border-right:20px solid transparent;
      border-top:40px solid rgba(51,150,255,0.4);
      transform-origin:center bottom;margin-left:-20px;margin-top:-40px;z-index:1;
    }
    .MapWalker .figure{
      position:absolute;top:50%;left:50%;width:0;height:0;
      border-left:8px solid transparent;border-right:8px solid transparent;
      border-bottom:16px solid #ff3300;
      transform-origin:center center;margin-left:-8px;margin-top:-8px;z-index:2;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }
  </style>

  <!-- SDKs (ì œê³µ í‚¤ ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_KEY_PLACEHOLDER&libraries=services,drawing,clusterer"></script>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=NAVER_KEY_PlACEHOLDER"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_KEY_PLACEHOLDER&callback=init"></script>
</head>

<body>
<div id="controls">
  <div class="panel">
    LEFT:
    <select id="leftSelect">
      <option value="google">Google</option>
      <option value="kakao">Kakao</option>
      <option value="naver">Naver</option>
    </select>
    <button id="leftType">ì§€ë„/ìœ„ì„±</button>
  </div>
  <div class="panel">
    RIGHT:
    <select id="rightSelect">
      <option value="google">Google</option>
      <option value="kakao">Kakao</option>
      <option value="naver">Naver</option>
    </select>
    <button id="rightType">ì§€ë„/ìœ„ì„±</button>
  </div>
  <div class="panel" style="position:relative;">
    ê²€ìƒ‰: <input id="searchInput" placeholder="ì£¼ì†Œ ë˜ëŠ” ì§€ëª… ì…ë ¥" autocomplete="off"/>
    
    <button id="searchBtn">Go</button>
    <!-- ìš”ì²­ 1: 'ì§€ìš°ê¸°' â†’ 'ì§€ì›€'ìœ¼ë¡œ ë³€ê²½, ìš”ì²­ 2: Go ë²„íŠ¼ í¬ê¸° ë™ì¼í•˜ê²Œ -->
    <button id="clearSearchBtn" style="padding:0px 10px;font-size:14px;">ì§€ ì›€</button>
    <div id="suggestList"></div>
  </div>
</div>

<div id="container">
  <div id="leftMap" class="map"></div>
  <div id="rightMap" class="map"></div>
</div>

<script>
/* ===== ìƒíƒœ ===== */
let syncing=false;
let state={lat:37.5665,lng:126.9780,zoom:13};
let left={type:"google",map:null,satellite:true};
let right={type:"kakao",map:null,satellite:false};

/* GIS ë³€ìˆ˜ (ì¹´ì¹´ì˜¤) */
let kakaoMap=null, kakaoRv=null, kakaoRvClient=null, kakaoWalker=null, kakaoGeocoder=null, kakaoPs=null;
let currentMode='default', drawingObject=null, drawingPath=[], allOverlays=[], allShapes=[], allMarkers=[], kakaoSearchMarker=null;
let kakaoRvMode=false, syncLock=false;

/* ê²€ìƒ‰ ë§ˆì»¤ (ì¢Œ/ìš° ê°ê°) */
let searchMarkerLeft = null;
let searchMarkerRight = null;

/* ìš°í´ë¦­ í’ì„  ì˜¤ë²„ë ˆì´ ë° ë§ˆì»¤ */
let rightClickOverlay=null;
let rightClickMarker=null;

/* DOM ìš”ì†Œ */
let kakaoWrap, kakaoRoadviewEl, kakaoMapEl, rvCloseBtn, kakaoToolbar;
let districtBtn, roadviewBtn, distanceBtn, areaBtn, clearBtn;

function init(){
  leftSelect.value=left.type; rightSelect.value=right.type;
  createMaps();
  bindUI();
  applyType(left,leftType);
  applyType(right,rightType);
}

/* ===== ë§µ ìƒì„±/íŒŒê´´ ===== */
function createMaps(){
  destroyMap(left);
  left.map=createMap(left.type,"leftMap");

  destroyMap(right);
  if(right.type==="kakao"){
    createKakaoGISMap();
  }else{
    hideKakaoElements();
    right.map=createMap(right.type,"rightMap");
  }

  bindEvents(left,right);
  bindEvents(right,left);
}

function destroyMap(side){
  if(side.map){
    if(side.type==="google") side.map=null;
    if(side.type==="naver") side.map?.destroy?.();
    if(side.type==="kakao" && side.map!==kakaoMap) side.map=null;
  }
}

function createMap(type,id){
  const el=document.getElementById(id);
  el.innerHTML="";
  if(type==="google"){
    return new google.maps.Map(el,{
      center:state,
      zoom:state.zoom,
      mapTypeId:"satellite",
      maxZoom:21,
      zoomControl: true,           /* í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ í‘œì‹œ (ê¸°ë³¸ê°’ true) */
      zoomControlOptions: {        /* â† ë°” ìŠ¤íƒ€ì¼ ì§€ì • */
      position: google.maps.ControlPosition.RIGHT,  /* ìš°í•˜ë‹¨ ìœ„ì¹˜ */
      style: google.maps.ZoomControlStyle.ZoomControlStyle           /* ë°” ëª¨ì–‘ */      
      }
    });
  }
  if(type==="kakao"){
    return new kakao.maps.Map(el,{
      center:new kakao.maps.LatLng(state.lat,state.lng),
      level:zoomToKakao(state.zoom)
    });
  }
  if(type==="naver"){
    return new naver.maps.Map(el,{
      center:new naver.maps.LatLng(state.lat,state.lng),
      zoom:state.zoom,
      maxZoom:21
    });
  }
}

/* ===== ì¹´ì¹´ì˜¤ GIS ë§µ ===== */
function createKakaoGISMap(){
  const rightEl=document.getElementById("rightMap");
  rightEl.innerHTML="";

  kakaoWrap=document.createElement("div");
  kakaoWrap.className="kakao-wrap-inner";

  kakaoRoadviewEl=document.createElement("div");
  kakaoRoadviewEl.id="kakao-roadview";

  rvCloseBtn=document.createElement("div");
  rvCloseBtn.id="rv-close-btn";
  rvCloseBtn.innerHTML="ë¡œë“œë·° ë‹«ê¸° X";
  rvCloseBtn.onclick=closeKakaoRoadviewUI;

  kakaoMapEl=document.createElement("div");
  kakaoMapEl.id="kakao-map";

  /* GIS íˆ´ë°” */
  kakaoToolbar=document.createElement("div");
  kakaoToolbar.className="kakao-toolbar";

  roadviewBtn=document.createElement("button");
  roadviewBtn.id="btn-roadview";
  roadviewBtn.innerHTML="ë¡œë“œë·°";
  roadviewBtn.onclick=()=>toggleMode('roadview');

  districtBtn=document.createElement("button");
  districtBtn.id="btn-district";
  districtBtn.innerHTML="ì§€ì ë„";
  districtBtn.onclick=()=>toggleOverlay('district');

  distanceBtn=document.createElement("button");
  distanceBtn.id="btn-distance";
  distanceBtn.innerHTML="ê±°ë¦¬";
  distanceBtn.onclick=()=>toggleMode('distance');

  areaBtn=document.createElement("button");
  areaBtn.id="btn-area";
  areaBtn.innerHTML="ë©´ì ";
  areaBtn.onclick=()=>toggleMode('area');

  clearBtn=document.createElement("button");
  clearBtn.className="delete-btn";
  clearBtn.innerHTML="ì´ˆê¸°í™”";
  clearBtn.onclick=clearMeasurements;

  kakaoToolbar.append(roadviewBtn,districtBtn,distanceBtn,areaBtn,clearBtn);

  kakaoMapEl.appendChild(kakaoToolbar);
  kakaoWrap.append(kakaoRoadviewEl,rvCloseBtn,kakaoMapEl);
  rightEl.appendChild(kakaoWrap);

  // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
  kakaoMap=new kakao.maps.Map(kakaoMapEl,{
    center:new kakao.maps.LatLng(state.lat,state.lng),
    level:zoomToKakao(state.zoom)
  });

  kakaoMap.addControl(new kakao.maps.ZoomControl(),kakao.maps.ControlPosition.RIGHT);
  kakaoRv=new kakao.maps.Roadview(kakaoRoadviewEl);
  kakaoRvClient=new kakao.maps.RoadviewClient();
  kakaoGeocoder=new kakao.maps.services.Geocoder();
  kakaoPs=new kakao.maps.services.Places();

  // GIS ì´ë²¤íŠ¸
  kakao.maps.event.addListener(kakaoMap,'center_changed',syncFromKakaoGIS);
  kakao.maps.event.addListener(kakaoMap,'zoom_changed',syncFromKakaoGIS);
  kakao.maps.event.addListener(kakaoMap,'click',onMapClick);
  kakao.maps.event.addListener(kakaoMap,'mousemove',onMapMouseMove);
  kakao.maps.event.addListener(kakaoMap,'rightclick',onMapRightClick);

  // ë¡œë“œë·° ì´ë²¤íŠ¸
  kakao.maps.event.addListener(kakaoRv,'viewpoint_changed',onRoadviewViewpointChanged);
  kakao.maps.event.addListener(kakaoRv,'position_changed',onRoadviewPositionChanged);

  right.map=kakaoMap;
}

function hideKakaoElements(){
  if(kakaoWrap) kakaoWrap.style.display="none";
  currentMode='default';
  kakaoRvMode=false;
  clearMeasurements();
}

/* ===== GIS ê¸°ëŠ¥ ===== */
function toggleOverlay(type){
  if(type==='district'){
    const btn=districtBtn;
    if(btn.classList.contains('active')){
      kakaoMap.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
      btn.classList.remove('active');
    }else{
      kakaoMap.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
      btn.classList.add('active');
    }
  }
}

function toggleMode(mode){
  if(!kakaoMap) return;
  stopDrawing();

  if(mode==='roadview' && currentMode==='roadview'){
    toggleMode('default');
    return;
  }

  [roadviewBtn,distanceBtn,areaBtn].forEach(btn=>btn.classList.remove('active'));
  const targetBtn=document.getElementById('btn-'+mode);
  if(targetBtn) targetBtn.classList.add('active');

  if(currentMode==='roadview' && mode!=='roadview'){
    closeKakaoRoadviewUI();
  }

  currentMode=mode;

  if(mode==='roadview'){
    kakaoRvMode=true;
    kakaoRoadviewEl.style.display='block';
    rvCloseBtn.style.display='block';
    kakaoMapEl.classList.add('minimap');
    kakaoMap.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    setTimeout(()=>{
      kakaoMap.relayout();
      kakaoRv.relayout();
      toggleRoadview(kakaoMap.getCenter());
    },300);
  }else if(mode==='distance'||mode==='area'){
    kakaoMap.setCursor('crosshair');
  }else{
    kakaoMap.setCursor('default');
    if(kakaoRvMode) closeKakaoRoadviewUI();
  }
}

function closeKakaoRoadviewUI(){
  kakaoRvMode=false;
  currentMode='default';
  kakaoRoadviewEl.style.display='none';
  rvCloseBtn.style.display='none';
  kakaoMapEl.classList.remove('minimap');
  kakaoMap.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);

  [roadviewBtn,distanceBtn,areaBtn].forEach(btn=>btn.classList.remove('active'));

  if(kakaoWalker){
    kakaoWalker.setMap(null);
    kakaoWalker=null;
  }
  setTimeout(()=>{kakaoMap.relayout();},300);
}

function toggleRoadview(position){
  kakaoRvClient.getNearestPanoId(position,50,(panoId)=>{
    if(panoId){
      kakaoRv.setPanoId(panoId,position);
      initWalker(position);
    }
  });
}

/* ===== ìš”ì²­ 3: ìš°í´ë¦­ ì£¼ì†Œë³´ê¸° - ê²½ê³ ì°½ â†’ í’ì„  ë„ì›€ë§ë¡œ ë³€ê²½ ===== */
function onMapRightClick(mouseEvent){
  const pos=mouseEvent.latLng;
  
  if(currentMode==='distance' || currentMode==='area'){
    if(drawingObject && drawingPath.length > 0){
      const content=currentMode==='distance'
        ? `<div class="info-overlay">ì´ ê±°ë¦¬ <span class="number">${Math.round(drawingObject.getLength()).toLocaleString()}m</span></div>`
        : (()=>{
            const area=Math.round(drawingObject.getArea());
            const pyeong=(area*0.3025).toFixed(1);
            return `<div class="info-overlay">ì´ ë©´ì  <span class="number">${area.toLocaleString()}mÂ²</span><br><span class="desc">(${Number(pyeong).toLocaleString()}í‰)</span></div>`;
          })();

      const overlay=new kakao.maps.CustomOverlay({
        map:kakaoMap,
        position:pos,
        content:content,
        yAnchor:1
      });
      allOverlays.push(overlay);
      allShapes.push(drawingObject);
      drawingObject=null;
      drawingPath=[];
      return;
    }
  }
  
  // ê¸°ì¡´ alert ì œê±° â†’ í’ì„  ë„ì›€ë§ í‘œì‹œ
  kakaoGeocoder.coord2Address(pos.getLng(), pos.getLat(), (result, status)=>{
    let address = 'ì£¼ì†Œì •ë³´ ì—†ìŒ';
    if(status === kakao.maps.services.Status.OK && result[0]){
      const addrObj = result[0];
      if (addrObj.road_address) {
        address = addrObj.road_address.address_name;
      } else if (addrObj.address) {
        address = addrObj.address.address_name;
      }
    }

    // ê¸°ì¡´ í’ì„ /ë§ˆì»¤ ì œê±°
    if(rightClickOverlay){ rightClickOverlay.setMap(null); rightClickOverlay=null; }
    if(rightClickMarker){ rightClickMarker.setMap(null); rightClickMarker=null; }

    // í’ì„  ë„ì›€ë§ ìƒì„±
    const contentHTML = `
      <div style="
        background:white;border:1px solid #444;padding:8px 10px;
        border-radius:6px;font-size:12px;white-space:nowrap;
        box-shadow:1px 2px 4px rgba(0,0,0,0.3);
      ">
        ğŸ“ ${address}<br><span style="color:#555;">(${pos.getLat().toFixed(6)}, ${pos.getLng().toFixed(6)})</span>
      </div>`;

    rightClickOverlay = new kakao.maps.CustomOverlay({
      map: kakaoMap,
      position: pos,
      content: contentHTML,
      yAnchor: 2.0
    });

    // ì²´í¬ ë§ˆì»¤ ìƒì„±
    rightClickMarker = new kakao.maps.Marker({
      position: pos,
      map: kakaoMap,
      zIndex: 1
    });

    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(()=>{
      if(rightClickOverlay){ rightClickOverlay.setMap(null); rightClickOverlay=null; }
      if(rightClickMarker){ rightClickMarker.setMap(null); rightClickMarker=null; }
    }, 5000);
  });
}

function onMapClick(mouseEvent){
  const pos=mouseEvent.latLng;

  if(currentMode==='roadview'){
    toggleRoadview(pos);
    return;
  }
  if(currentMode!=='distance' && currentMode!=='area') return;

  drawingPath.push(pos);
  const marker=new kakao.maps.Marker({position:pos,map:kakaoMap});
  allMarkers.push(marker);

  if(!drawingObject){
    drawingObject=currentMode==='distance'
      ? new kakao.maps.Polyline({
          map:kakaoMap,
          path:[pos],
          strokeWeight:3,
          strokeColor:'#db4040',
          strokeOpacity:1,
          strokeStyle:'solid'
        })
      : new kakao.maps.Polygon({
          map:kakaoMap,
          path:[pos],
          strokeWeight:3,
          strokeColor:'#39f',
          strokeOpacity:0.8,
          strokeStyle:'longdash',
          fillColor:'#39f',
          fillOpacity:0.2
        });
  }else{
    drawingObject.setPath(drawingPath);
    const content=currentMode==='distance'
      ? `<div class="measure-label">${Math.round(drawingObject.getLength()).toLocaleString()}m</div>`
      : (drawingPath.length>=3
          ? `<div class="measure-label">${Math.round(drawingObject.getArea()).toLocaleString()}mÂ²</div>`
          : '');
    if(content){
      const overlay=new kakao.maps.CustomOverlay({
        map:kakaoMap,
        position:pos,
        content:content,
        yAnchor:2.5
      });
      allOverlays.push(overlay);
    }
  }
}

function onMapMouseMove(mouseEvent){
  if(!drawingObject) return;
  const path=drawingPath.slice();
  path.push(mouseEvent.latLng);
  drawingObject.setPath(path);
}

function clearMeasurements(){
  allOverlays.forEach(o=>o.setMap(null));
  allShapes.forEach(s=>s.setMap(null));
  allMarkers.forEach(m=>m.setMap(null));
  if(kakaoSearchMarker){ kakaoSearchMarker.setMap(null); kakaoSearchMarker=null; }
  allOverlays=[];
  allShapes=[];
  allMarkers=[];
  stopDrawing();
  toggleMode('default');
}

function stopDrawing(){
  if(drawingObject){
    drawingObject.setMap(null);
    drawingObject=null;
    drawingPath=[];
  }
}

/* ===== ì›Œì»¤ (ë¡œë“œë·° ë§ˆì»¤) ===== */
function createWalkerContent(angle){
  return `<div class="MapWalker">
    <div class="angleBack" style="transform:rotate(${angle}deg);"></div>
    <div class="figure" style="transform:rotate(${angle}deg);"></div>
  </div>`;
}

function initWalker(position){
  if(kakaoWalker){
    kakaoWalker.setMap(null);
    kakaoWalker=null;
  }
  kakaoWalker=new kakao.maps.CustomOverlay({
    position,
    content:createWalkerContent(0),
    map:kakaoMap
  });
}

function moveWalker(position){
  if(kakaoWalker) kakaoWalker.setPosition(position);
}

function onRoadviewViewpointChanged(){
  if(kakaoWalker && kakaoRv){
    const viewpoint=kakaoRv.getViewpoint();
    kakaoWalker.setContent(createWalkerContent(viewpoint.pan));
  }
}

function onRoadviewPositionChanged(){
  if(kakaoRv){
    const rvPos=kakaoRv.getPosition();
    moveWalker(rvPos);
    kakaoMap.setCenter(rvPos);
  }
}

/* ===== ë™ê¸°í™” ===== */
function syncFromKakaoGIS(){
  if(syncing||!kakaoMap||kakaoRvMode) return;
  syncing=true;
  syncLock=true;
  const c=kakaoMap.getCenter();
  const lvl=kakaoMap.getLevel();
  state.lat=c.getLat();
  state.lng=c.getLng();
  state.zoom=kakaoToZoom(lvl);
  applyTo(left);
  setTimeout(()=>{syncing=false;syncLock=false;},50);
}

function bindEvents(src,target){
  if(!src.map) return;
  if(src.type==="google"){
    src.map.addListener("center_changed",()=>syncFromGoogle(src,target));
    src.map.addListener("zoom_changed",()=>syncFromGoogle(src,target));
    src.map.addListener("drag",()=>syncFromGoogle(src,target));
  }
  if(src.type==="kakao" && src.map!==kakaoMap){
    kakao.maps.event.addListener(src.map,"center_changed",()=>syncFromKakao(src,target));
    kakao.maps.event.addListener(src.map,"zoom_changed",()=>syncFromKakao(src,target));
  }
  if(src.type==="naver"){
    naver.maps.Event.addListener(src.map,"idle",()=>syncFromNaver(src,target));
  }
}

function syncFromGoogle(src,target){
  if(syncing) return;
  syncing=true;
  syncLock=true;
  const c=src.map.getCenter();
  state={lat:c.lat(),lng:c.lng(),zoom:src.map.getZoom()};
  applyTo(target);
  setTimeout(()=>{syncing=false;syncLock=false;},50);
}

function syncFromKakao(src,target){
  if(syncing) return;
  syncing=true;
  syncLock=true;
  const c=src.map.getCenter();
  state.lat=c.getLat();
  state.lng=c.getLng();
  state.zoom=kakaoToZoom(src.map.getLevel());
  applyTo(target);
  setTimeout(()=>{syncing=false;syncLock=false;},50);
}

function syncFromNaver(src,target){
  if(syncing) return;
  syncing=true;
  syncLock=true;
  const c=src.map.getCenter();
  state={lat:c.lat(),lng:c.lng(),zoom:src.map.getZoom()};
  applyTo(target);
  setTimeout(()=>{syncing=false;syncLock=false;},50);
}

function applyTo(target){
  if(!target.map) return;
  if(target.type==="google"){
    target.map.setCenter(state);
    target.map.setZoom(Math.min(state.zoom,21));
  }
  if(target.type==="kakao"){
    const lvl=zoomToKakao(state.zoom);
    const center=new kakao.maps.LatLng(state.lat,state.lng);
    if(target.map===kakaoMap && !kakaoRvMode){
      target.map.setCenter(center);
      target.map.setLevel(lvl);
    }else if(target.map!==kakaoMap){
      target.map.setCenter(center);
      target.map.setLevel(lvl);
    }
  }
  if(target.type==="naver"){
    target.map.setCenter(new naver.maps.LatLng(state.lat,state.lng));
    target.map.setZoom(Math.min(state.zoom,21));
  }
}

/* ===== íƒ€ì… ë³€ê²½ (ì™¸ë¶€ í† ê¸€ë§Œ ì‚¬ìš©) ===== */
function toggleType(side,btn){
  side.satellite=!side.satellite;
  applyType(side,btn);
}

function applyType(side,btn){
  if(!side.map) return;
  if(side.type==="google"){
    side.map.setMapTypeId(side.satellite?"satellite":"roadmap");
  }
  if(side.type==="kakao"){
    side.map.setMapTypeId(
      side.satellite ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP
    );
  }
  if(side.type==="naver"){
    side.map.setMapTypeId(
      side.satellite ? naver.maps.MapTypeId.SATELLITE : naver.maps.MapTypeId.NORMAL
    );
  }
}

/* ===== ìƒë‹¨ ê²€ìƒ‰ UI ===== */
function bindUI(){
  leftSelect.onchange=()=>{left.type=leftSelect.value;createMaps();};
  rightSelect.onchange=()=>{right.type=rightSelect.value;createMaps();};
  leftType.onclick=()=>toggleType(left,leftType);
  rightType.onclick=()=>toggleType(right,rightType);

  const input=document.getElementById("searchInput");
  const btn=document.getElementById("searchBtn");
  const clearBtnSearch=document.getElementById("clearSearchBtn");

  input.addEventListener("input",()=>{
    const q=input.value.trim();
    const suggestList=document.getElementById("suggestList");
    if(!q){
      suggestList.style.display="none";
      return;
    }
    if(kakaoPs){
      kakaoPs.keywordSearch(q,(r,s)=>{
        if(s!==kakao.maps.services.Status.OK || !r.length){
          suggestList.style.display="none";
          return;
        }
        suggestList.innerHTML="";
        r.slice(0,10).forEach(item=>{
          const div=document.createElement("div");
          div.textContent=item.place_name+
            (item.road_address_name?" ("+item.road_address_name+")":"");
          div.onclick=()=>{
            state.lat=parseFloat(item.y);
            state.lng=parseFloat(item.x);
            state.zoom=18;
            applyTo(left);
            applyTo(right);
            showSearchMarkersOnBoth(state.lat, state.lng);
            suggestList.style.display="none";
            input.value=item.place_name;
          };
          suggestList.appendChild(div);
        });
        suggestList.style.display="block";
      });
    }
  });

  input.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      document.getElementById("suggestList").style.display="none";
      const q=input.value.trim();
      if(q) searchKeyword(q);
    }
  });

  btn.onclick=()=>{
    document.getElementById("suggestList").style.display="none";
    const q=input.value.trim();
    if(q) searchKeyword(q);
  };

  // ì§€ì›€ ë²„íŠ¼ ê¸°ëŠ¥ (ìš”ì²­ì‚¬í•­1-2 ì ìš©)
  clearBtnSearch.onclick=()=>{
    input.value="";
    document.getElementById("suggestList").style.display="none";

    // ì¢Œì¸¡ ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
    if(searchMarkerLeft){
      if(left.type==="google" || left.type==="kakao" || left.type==="naver"){
        searchMarkerLeft.setMap(null);
      }
      searchMarkerLeft=null;
    }
    // ìš°ì¸¡ ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
    if(searchMarkerRight){
      if(right.type==="google" || right.type==="kakao" || right.type==="naver"){
        searchMarkerRight.setMap(null);
      }
      searchMarkerRight=null;
    }
    // ìš°ì¸¡ ì¹´ì¹´ì˜¤ GIS ì „ìš© ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
    if(kakaoSearchMarker){
      kakaoSearchMarker.setMap(null);
      kakaoSearchMarker=null;
    }
  };

  document.addEventListener("click",e=>{
    if(!e.target.closest("#controls")){
      document.getElementById("suggestList").style.display="none";
    }
  });
}

/* ===== ê²€ìƒ‰ ë§ˆì»¤ í‘œì‹œ (ì¢Œ/ìš° ëª¨ë‘) ===== */
function showSearchMarkersOnBoth(lat, lng){
  showSearchMarkerForSide('left', lat, lng);
  showSearchMarkerForSide('right', lat, lng);
}

function showSearchMarkerForSide(sideName, lat, lng){
  const side = sideName === 'left' ? left : right;
  let markerRef = sideName === 'left' ? searchMarkerLeft : searchMarkerRight;

  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
  if(markerRef){
    if(side.type === 'kakao' || side.type === 'google' || side.type === 'naver'){
      markerRef.setMap(null);
    }
  }

  if(!side.map) return;

  // ì¢Œìš° íƒ€ì…ë³„ ë§ˆì»¤ ìƒì„±
  if(side.type === 'google'){
    const position = {lat: lat, lng: lng};
    markerRef = new google.maps.Marker({
      position: position,
      map: side.map,
      icon: {
        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDBMMCAxNiBMNiAxNiBMNiAyNCBMMTIgMjQgTDE4IDE2IEwyNCAxNiBaIiBmaWxsPSIjRkY0MDAwIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9IiNGRkYiLz4KPC9zdmc+',
        scaledSize: new google.maps.Size(24, 32)
      }
    });
  }else if(side.type === 'naver'){
    markerRef = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: side.map
    });
  }else if(side.type === 'kakao'){
    markerRef = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(lat, lng),
      map: side.map
    });
  }

  if(sideName === 'left'){
    searchMarkerLeft = markerRef;
  }else{
    searchMarkerRight = markerRef;
  }
}

function searchKeyword(q){
  if(kakaoGeocoder && kakaoPs){
    kakaoGeocoder.addressSearch(q,(res,status)=>{
      if(status===kakao.maps.services.Status.OK && res[0]){
        state.lat=parseFloat(res[0].y);
        state.lng=parseFloat(res[0].x);
        state.zoom=18;
        applyTo(left);
        applyTo(right);
        showSearchMarkersOnBoth(state.lat, state.lng);
        // ìš°ì¸¡ ì¹´ì¹´ì˜¤ GIS ë§µ ë§ˆì»¤
        if(kakaoMap){
          if(kakaoSearchMarker) kakaoSearchMarker.setMap(null);
          kakaoSearchMarker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(state.lat, state.lng),
            map: kakaoMap
          });
        }
      }else{
        kakaoPs.keywordSearch(q,(r,s)=>{
          if(s===kakao.maps.services.Status.OK && r[0]){
            state.lat=parseFloat(r[0].y);
            state.lng=parseFloat(r[0].x);
            state.zoom=18;
            applyTo(left);
            applyTo(right);
            showSearchMarkersOnBoth(state.lat, state.lng);
            // ìš°ì¸¡ ì¹´ì¹´ì˜¤ GIS ë§µ ë§ˆì»¤
            if(kakaoMap){
              if(kakaoSearchMarker) kakaoSearchMarker.setMap(null);
              kakaoSearchMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(state.lat, state.lng),
                map: kakaoMap
              });
            }
          }
        });
      }
    });
  }
}

/* ===== Zoom ë³€í™˜ ===== */
function zoomToKakao(z){
  let l=20-z;
  return Math.max(1,Math.min(14,l));
}
function kakaoToZoom(l){
  let z=20-l;
  return Math.max(3,Math.min(20,z));
}
</script>
</body>
</html>

