<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Dual Map GIS: Google Street View Restored</title>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Malgun Gothic', dotum, sans-serif; overflow: hidden; }
        
        .container { display: flex; width: 100%; height: 100%; transition: all 0.3s; }

        /* 좌측: 구글맵 */
        #google-map-wrap { width: 50%; height: 100%; position: relative; border-right: 1px solid #aaa; box-sizing: border-box; }
        #google-map { width: 100%; height: 100%; }

        /* 우측: 카카오맵 */
        .map_wrap { position: relative; width: 50%; height: 100%; }
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; background: #eee; }
        
        /* 미니맵 스타일 */
        #map.minimap {
            width: 300px !important; height: 250px !important; 
            top: auto !important; bottom: 10px; left: 10px;
            z-index: 20; 
            border: 2px solid #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
        }

        #roadview { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 5; background: #333; display: none; }
        #resizer { position: absolute; top: 0; right: 0; width: 20px; height: 20px; background: #3396ff; cursor: nesw-resize; z-index: 100; display: none; border-bottom-left-radius: 5px; }

        #rv-close-btn { position: absolute; top: 10px; right: 10px; z-index: 30; padding: 5px 8px; background: #333; color: white; border: 1px solid #555; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 11px; display: none; }
        #rv-close-btn:hover { background: #555; }

        /* 검색 박스 스타일 (60% 크기) */
        .search_wrap { position: absolute; top: 10px; left: 10px; z-index: 30; width: 180px; }
        .search_box { background: white; padding: 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; gap: 3px; position: relative; }
        .search_box input { width: 120px; padding: 3px 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; height: 18px; }
        .search_box button { padding: 3px 8px; background: #3396ff; color: white; border: none; border-radius: 3px; cursor: pointer; flex-shrink: 0; font-size: 11px; }
        
        /* 자동완성 리스트 박스 */
        #suggestion_box {
            display: none;
            position: absolute;
            top: 35px;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            max-height: 250px;
            overflow-y: auto;
            z-index: 40;
        }
        .suggest-item { padding: 6px 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 11px; }
        .suggest-item:last-child { border-bottom: none; }
        .suggest-item:hover { background: #f0f8ff; }
        .suggest-item .place-name { font-weight: bold; color: #333; display: block;}
        .suggest-item .address-name { font-size: 10px; color: #888; display: block; margin-top: 2px; }

        /* 지도 타입 컨트롤 스타일 */
        .map-type-bar {
            position: absolute; top: 10px; z-index: 30;
            background: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex; overflow: hidden;
        }
        .map-type-bar button { background: #fff; border: 0; border-right: 1px solid #ddd; padding: 5px 8px; cursor: pointer; font-weight: bold; font-size: 11px; outline: none; }
        .map-type-bar button:last-child { border-right: none; }
        .map-type-bar button.active { background: #3396ff; color: white; }

        .google-bar { left: 10px; }
        .kakao-bar { right: 10px; }

        /* 툴바 스타일 */
        .toolbar { 
            position: absolute; top: 45px; 
            right: 10px; z-index: 30; 
            background: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            display: flex; overflow: hidden; 
        }
        .toolbar button { background: #fff; border: 0; border-right: 1px solid #ddd; padding: 5px 8px; cursor: pointer; font-weight: bold; font-size: 11px; outline: none; }
        .toolbar button:last-child { border-right: none; }
        .toolbar button:hover { background: #f5f5f5; }
        .toolbar button.active { background: #3396ff; color: white; }
        .toolbar button.delete-btn { color: #e14f4f; }

        /* 오버레이 스타일 */
        .info-overlay { background: white; border: 1px solid #333; border-radius: 4px; padding: 8px; font-size: 11px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); white-space: nowrap; }
        .measure-label { background: #fff; padding: 2px 5px; border: 1px solid #888; border-radius: 3px; font-size: 10px; color: #333; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); white-space: nowrap; }
        
        /* 주소 표시 오버레이 */
        .addr-overlay { background: rgba(255,255,255,0.95); border: 1px solid #666; padding: 8px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); min-width: 130px; }
        .addr-overlay .title { font-weight: bold; margin-bottom: 4px; display: block; color: #3396ff; border-bottom: 1px solid #eee; padding-bottom: 2px; font-size: 11px;}
        .addr-overlay .addr-text { font-size: 11px; color: #333; margin-top: 2px; }
        
        .MapWalker { position: absolute; width: 24px; height: 24px; margin: -12px 0 0 -12px; pointer-events: none; }
        .MapWalker .angleBack { position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid rgba(51, 150, 255, 0.4); transform-origin: center bottom; margin-left: -20px; margin-top: -40px; z-index: 1; }
        .MapWalker .figure { position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid #ff3300; transform-origin: center center; margin-left: -8px; margin-top: -8px; z-index: 2; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        
        .error-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #555; display: none; z-index: 999; background: rgba(255,255,255,0.8); padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="google-map-wrap">
        <div id="google-map"></div>
        <!-- 구글맵 커스텀 컨트롤 -->
        <div class="map-type-bar google-bar">
            <button onclick="setGoogleMapType('roadmap')" id="btn-gmap-base" class="active">지도</button>
            <button onclick="setGoogleMapType('satellite')" id="btn-gmap-sat">위성</button>
        </div>
    </div>

    <!-- 카카오맵 커스텀 컨트롤 -->
    <div class="map-type-bar kakao-bar">
        <button onclick="setKakaoMapType('base')" id="btn-map-base" class="active">지도</button>
        <button onclick="setKakaoMapType('hybrid')" id="btn-map-hybrid">위성</button>
    </div>

    <div class="map_wrap" id="kakao-wrap">
        <div id="roadview"></div>
        <div id="rv-close-btn" onclick="toggleMode('default')">로드뷰 닫기 X</div>

        <div id="map">
            <div id="resizer"></div>
            
            <div class="search_wrap">
                <div class="search_box">
                    <input type="text" id="keyword" placeholder="주소, 건물명" autocomplete="off" onkeypress="if(event.keyCode==13) searchPlaces();" onkeyup="handleInput(this.value)">
                    <button onclick="searchPlaces()">검색</button>
                </div>
                <div id="suggestion_box"></div>
            </div>

            <!-- 툴바 -->
            <div class="toolbar">
                <button onclick="toggleOverlay('district')" id="btn-district">지적</button>
                <button onclick="toggleMode('roadview')" id="btn-roadview">로드뷰</button>
                <button onclick="toggleMode('distance')" id="btn-distance">거리</button>
                <button onclick="toggleMode('area')" id="btn-area">면적</button>
                <button onclick="clearMeasurements()" class="delete-btn">초기화</button>
            </div>
        </div>
    </div>
</div>

<div id="error-message" class="error-msg">
    <h3>지도를 불러올 수 없습니다.</h3>
    <p>API 키 설정을 확인해주세요.</p>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d2d116d6a534a98e73133808f5843a6&libraries=services,drawing,clusterer"></script>

<script>
    var mapContainer = document.getElementById('map');
    var rvContainer = document.getElementById('roadview');
    var rvCloseBtn = document.getElementById('rv-close-btn');
    var resizer = document.getElementById('resizer');
    
    var googleMapWrap = document.getElementById('google-map-wrap');
    var kakaoWrap = document.getElementById('kakao-wrap');
    var suggestionBox = document.getElementById('suggestion_box');

    var map = null; 
    var gMap = null; 
    var syncLock = false; 

    var geocoder = null;
    var ps = null;

    var rv = new kakao.maps.Roadview(rvContainer);
    var rvClient = new kakao.maps.RoadviewClient();
    
    var mapWalker = null;
    var rvMarker = null;
    var searchMarker = null;
    var addressOverlay = null;
    var highlightCircle = null; 

    var currentMode = 'default';
    var drawingObject = null;
    var drawingPath = [];
    var allOverlays = []; 
    var allShapes = [];   
    var allMarkers = [];  

    var startLat = 37.566826;
    var startLng = 126.9786567;
    
    var searchTimer = null;

    if (typeof kakao === 'undefined') {
        document.getElementById('error-message').style.display = 'block';
    } else {
        var mapOption = { center: new kakao.maps.LatLng(startLat, startLng), level: 3 };
        map = new kakao.maps.Map(mapContainer, mapOption);
        
        ps = new kakao.maps.services.Places(); 
        geocoder = new kakao.maps.services.Geocoder(); 

        map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.LEFT);
        
        kakao.maps.event.addListener(map, 'center_changed', syncGoogleFromKakao);
        kakao.maps.event.addListener(map, 'zoom_changed', syncGoogleFromKakao);
        
        kakao.maps.event.addListener(map, 'click', function() {
            suggestionBox.style.display = 'none';
            if(addressOverlay) addressOverlay.setMap(null);
            if(highlightCircle) highlightCircle.setMap(null);
        });
    }

    // [수정] 구글맵 초기화 (스트리트뷰 복구)
    window.initGoogleMap = function() {
        var gOptions = { 
            center: { lat: startLat, lng: startLng }, 
            zoom: 17, 
            disableDefaultUI: true, // 기본 UI 숨김 유지 (커스텀 버튼 때문)
            
            // [중요] 스트리트뷰 및 줌 컨트롤 명시적 활성화 및 위치 설정
            streetViewControl: true,
            streetViewControlOptions: {
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            },
            zoomControl: true,
            zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            },
            scaleControl: true 
        };
        gMap = new google.maps.Map(document.getElementById('google-map'), gOptions);
        
        gMap.addListener('center_changed', syncKakaoFromGoogle);
        gMap.addListener('zoom_changed', syncKakaoFromGoogle);
        gMap.addListener('drag', syncKakaoFromGoogle);
    };

    function syncGoogleFromKakao() {
        if (!gMap || syncLock) return;
        syncLock = true;
        var center = map.getCenter();
        var kLevel = map.getLevel();
        var gZoom = 20 - kLevel;
        gMap.setCenter({ lat: center.getLat(), lng: center.getLng() });
        if(gMap.getZoom() !== gZoom) gMap.setZoom(gZoom);
        setTimeout(function(){ syncLock = false; }, 50);
    }

    function syncKakaoFromGoogle() {
        if (!map || syncLock) return;
        syncLock = true;
        var center = gMap.getCenter();
        var gZoom = gMap.getZoom();
        var kLevel = 20 - gZoom;
        if (kLevel < 1) kLevel = 1; if (kLevel > 14) kLevel = 14;
        map.setCenter(new kakao.maps.LatLng(center.lat(), center.lng()));
        if(map.getLevel() !== kLevel) map.setLevel(kLevel);
        setTimeout(function(){ syncLock = false; }, 50);
    }

    function setKakaoMapType(type) {
        var btnBase = document.getElementById('btn-map-base');
        var btnHybrid = document.getElementById('btn-map-hybrid');

        if (type === 'base') {
            map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
            btnBase.classList.add('active');
            btnHybrid.classList.remove('active');
        } else {
            map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
            btnBase.classList.remove('active');
            btnHybrid.classList.add('active');
        }
    }

    function setGoogleMapType(type) {
        if(!gMap) return;
        var btnBase = document.getElementById('btn-gmap-base');
        var btnSat = document.getElementById('btn-gmap-sat');

        if (type === 'roadmap') {
            gMap.setMapTypeId('roadmap');
            btnBase.classList.add('active');
            btnSat.classList.remove('active');
        } else {
            gMap.setMapTypeId('hybrid'); 
            btnBase.classList.remove('active');
            btnSat.classList.add('active');
        }
    }

    function createWalkerContent(angle) {
        return `<div class="MapWalker">
                    <div class="angleBack" style="transform: rotate(${angle}deg);"></div>
                    <div class="figure" style="transform: rotate(${angle}deg);"></div>
                </div>`;
    }

    function searchPlaces() {
        var keyword = document.getElementById('keyword').value.trim();
        suggestionBox.style.display = 'none'; 
        if(addressOverlay) addressOverlay.setMap(null);
        if(highlightCircle) highlightCircle.setMap(null);

        if (!keyword) { alert('키워드를 입력해주세요!'); return; }

        geocoder.addressSearch(keyword, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                moveAndMark(coords);
            } else {
                ps.keywordSearch(keyword, placesSearchCB);
            }
        });
    }

    function placesSearchCB(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
            var targetPosition = new kakao.maps.LatLng(data[0].y, data[0].x);
            moveAndMark(targetPosition);
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
            alert('검색 결과가 없습니다.');
        } else {
            alert('오류가 발생했습니다.');
        }
    }

    function moveAndMark(position) {
        if (searchMarker) searchMarker.setMap(null);
        searchMarker = new kakao.maps.Marker({ position: position, map: map });
        map.setCenter(position);
        map.setLevel(3);
        if (currentMode === 'roadview') toggleRoadview(position);
    }

    function handleInput(keyword) {
        if (searchTimer) clearTimeout(searchTimer);
        keyword = keyword.trim();
        if (keyword.length < 2) {
            suggestionBox.style.display = 'none';
            return;
        }
        searchTimer = setTimeout(function() {
            ps.keywordSearch(keyword, function(data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    renderSuggestions(data);
                } else {
                    suggestionBox.style.display = 'none';
                }
            });
        }, 300);
    }

    function renderSuggestions(places) {
        var html = '';
        var count = places.length > 10 ? 10 : places.length;
        for (var i = 0; i < count; i++) {
            var place = places[i];
            html += `<div class="suggest-item" onclick="selectSuggestion(${place.y}, ${place.x}, '${place.place_name}')">
                        <span class="place-name">${place.place_name}</span>
                        <span class="address-name">${place.road_address_name || place.address_name}</span>
                     </div>`;
        }
        suggestionBox.innerHTML = html;
        suggestionBox.style.display = 'block';
    }

    function selectSuggestion(lat, lng, name) {
        var coords = new kakao.maps.LatLng(lat, lng);
        document.getElementById('keyword').value = name;
        suggestionBox.style.display = 'none';
        moveAndMark(coords);
    }

    function toggleOverlay(type) {
        if (type === 'district') {
            var btn = document.getElementById('btn-district');
            if (btn.classList.contains('active')) {
                map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
                btn.classList.remove('active');
            } else {
                map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
                btn.classList.add('active');
            }
        }
    }

    function toggleMode(mode) {
        if (!map) return;
        stopDrawing();

        if (mode === 'roadview' && currentMode === 'roadview') {
            toggleMode('default'); 
            return;
        }

        document.querySelectorAll('.toolbar button').forEach(btn => {
            if(!btn.classList.contains('delete-btn') && btn.id !== 'btn-district') {
                btn.classList.remove('active');
            }
        });
        
        var targetBtn = document.getElementById('btn-' + mode);
        if(targetBtn) targetBtn.classList.add('active');

        if (currentMode === 'roadview' && mode !== 'roadview') {
            closeRoadviewUI();
        }

        currentMode = mode;

        if (mode === 'roadview') {
            rvContainer.style.display = 'block';
            rvCloseBtn.style.display = 'block';
            
            mapContainer.classList.add('minimap');
            map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);

            setTimeout(function() { 
                map.relayout(); 
                rv.relayout(); 
                toggleRoadview(map.getCenter());
            }, 300);

        } else if (mode === 'distance' || mode === 'area') {
            map.setCursor('crosshair');
        } else {
            map.setCursor('default');
            if (rvContainer.style.display === 'block') {
                closeRoadviewUI();
            }
        }
    }

    function closeRoadviewUI() {
        rvContainer.style.display = 'none';
        rvCloseBtn.style.display = 'none';
        
        mapContainer.classList.remove('minimap');
        resizer.style.display = 'none';

        mapContainer.style.width = '100%';
        mapContainer.style.height = '100%';

        map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
        
        if(mapWalker) { mapWalker.setMap(null); mapWalker = null; }
        if(rvMarker) { rvMarker.setMap(null); rvMarker = null; }
        
        setTimeout(function() { 
            map.relayout(); 
            if(gMap) google.maps.event.trigger(gMap, "resize");
            syncGoogleFromKakao(); 
        }, 300);
    }

    function toggleRoadview(position) {
        rvClient.getNearestPanoId(position, 50, function(panoId) {
            if (panoId) {
                rv.setPanoId(panoId, position);
                initWalker(position);
            }
        });
    }

    var isResizing = false;
    resizer.addEventListener('mousedown', function(e) { isResizing = true; e.preventDefault(); e.stopPropagation(); });
    window.addEventListener('mouseup', function() { if (isResizing) { isResizing = false; map.relayout(); } });

    function initWalker(position) {
        if(mapWalker) mapWalker.setMap(null);
        if(rvMarker) rvMarker.setMap(null);

        rvMarker = new kakao.maps.Marker({
            position: position,
            draggable: true,
            map: map,
            zIndex: 3 
        });

        mapWalker = new kakao.maps.CustomOverlay({
            position: position,
            content: createWalkerContent(0),
            map: map
        });

        kakao.maps.event.addListener(rvMarker, 'dragend', function() {
            var newPos = rvMarker.getPosition();
            rvClient.getNearestPanoId(newPos, 50, function(panoId) {
                if (panoId) {
                    rv.setPanoId(panoId, newPos);
                }
                moveWalker(newPos);
            });
        });

        map.setCenter(position);
    }

    function moveWalker(position) { 
        if(mapWalker) mapWalker.setPosition(position);
        if(rvMarker) rvMarker.setPosition(position);
    }

    kakao.maps.event.addListener(rv, 'viewpoint_changed', function() {
        var viewpoint = rv.getViewpoint();
        if(mapWalker) mapWalker.setContent(createWalkerContent(viewpoint.pan));
    });

    kakao.maps.event.addListener(rv, 'position_changed', function() {
        var rvPos = rv.getPosition();
        moveWalker(rvPos);
        map.setCenter(rvPos);
    });

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        var clickPosition = mouseEvent.latLng;
        suggestionBox.style.display = 'none';

        if (currentMode === 'roadview') { 
            toggleRoadview(clickPosition); 
            return; 
        }
        if (currentMode !== 'distance' && currentMode !== 'area') return;

        drawingPath.push(clickPosition);
        var marker = new kakao.maps.Marker({ position: clickPosition, map: map });
        allMarkers.push(marker);
        if (!drawingObject) {
            if (currentMode === 'distance') {
                drawingObject = new kakao.maps.Polyline({ map: map, path: [clickPosition], strokeWeight: 3, strokeColor: '#db4040', strokeOpacity: 1, strokeStyle: 'solid' });
            } else {
                drawingObject = new kakao.maps.Polygon({ map: map, path: [clickPosition], strokeWeight: 3, strokeColor: '#39f', strokeOpacity: 0.8, strokeStyle: 'longdash', fillColor: '#39f', fillOpacity: 0.2 });
            }
        } else {
            drawingObject.setPath(drawingPath);
            var content = '';
            if (currentMode === 'distance') {
                var dist = Math.round(drawingObject.getLength());
                content = `<div class="measure-label">${dist.toLocaleString()}m</div>`;
            } else if (currentMode === 'area') {
                if (drawingPath.length >= 3) {
                    var area = Math.round(drawingObject.getArea());
                    content = `<div class="measure-label">${area.toLocaleString()}m²</div>`;
                }
            }
            if (content) {
                var labelOverlay = new kakao.maps.CustomOverlay({ map: map, position: clickPosition, content: content, yAnchor: 2.5 });
                allOverlays.push(labelOverlay);
            }
        }
    });

    kakao.maps.event.addListener(map, 'mousemove', function(mouseEvent) {
        if (!drawingObject) return;
        var path = drawingPath.slice();
        path.push(mouseEvent.latLng);
        drawingObject.setPath(path);
    });

    // 우클릭 이벤트
    kakao.maps.event.addListener(map, 'rightclick', function(mouseEvent) {
        if (drawingObject) {
            var position = drawingPath[drawingPath.length - 1];
            var content = '';
            if (currentMode === 'distance') {
                var dist = Math.round(drawingObject.getLength());
                content = `<div class="info-overlay">총 거리 <span class="number">${dist.toLocaleString()}m</span></div>`;
            } else {
                var area = Math.round(drawingObject.getArea());
                var pyeong = (area * 0.3025).toFixed(1);
                content = `<div class="info-overlay">총 면적 <span class="number">${area.toLocaleString()}m²</span><br><span class="desc">(${Number(pyeong).toLocaleString()}평)</span></div>`;
            }
            var overlay = new kakao.maps.CustomOverlay({ map: map, position: position, content: content, yAnchor: 1 });
            allOverlays.push(overlay);
            allShapes.push(drawingObject);
            drawingObject = null;
            drawingPath = [];
            return;
        }

        var latlng = mouseEvent.latLng;

        // 빨간 원 강조
        if(highlightCircle) highlightCircle.setMap(null);
        highlightCircle = new kakao.maps.Circle({
            center : latlng,
            radius: 15, 
            strokeWeight: 3,
            strokeColor: '#FF0000',
            strokeOpacity: 1,
            strokeStyle: 'solid',
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map
        });

        // 주소 표시
        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var roadAddr = result[0].road_address ? '<div>도로명: ' + result[0].road_address.address_name + '</div>' : '';
                var jibunAddr = '<div>지번: ' + result[0].address.address_name + '</div>';

                var content = `<div class="addr-overlay">
                                <span class="title">주소정보</span>
                                <div class="addr-text">
                                    ${roadAddr}
                                    ${jibunAddr}
                                </div>
                               </div>`;

                if(addressOverlay) addressOverlay.setMap(null);
                addressOverlay = new kakao.maps.CustomOverlay({
                    map: map,
                    position: latlng,
                    content: content,
                    yAnchor: 1.2
                });
                addressOverlay.setMap(map);
            }
        });
    });

    function clearMeasurements() {
        allOverlays.forEach(o => o.setMap(null));
        allShapes.forEach(s => s.setMap(null));
        allMarkers.forEach(m => m.setMap(null));
        if(addressOverlay) addressOverlay.setMap(null);
        if(highlightCircle) highlightCircle.setMap(null);

        allOverlays = []; allShapes = []; allMarkers = [];
        stopDrawing();
        if (searchMarker) { searchMarker.setMap(null); searchMarker = null; }
        document.getElementById('keyword').value = '';
        suggestionBox.style.display = 'none';
        
        toggleMode('default');
    }
    function stopDrawing() { if (drawingObject) drawingObject.setMap(null); drawingObject = null; drawingPath = []; }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYXu5yKdW71VuKmI-N2M2xbvMaYTK2HCg&callback=initGoogleMap" async defer></script>
</body>
</html>
